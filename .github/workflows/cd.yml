name: CD

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'pyproject.toml'

    - name: Install dependencies
      run: 	pip install -e . --group build

    - name: Build package
      run: make build

    - name: Check build
      run: make check-build

    - name: Publish to PyPI
      run: |
        echo "## ðŸ“¦ Publishing to PyPI" >> $GITHUB_STEP_SUMMARY
        if make publish > publish_output.txt 2>&1; then
          # Extract package name and version
          PACKAGE_NAME=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])")
          PACKAGE_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")

          echo "âœ… **Package published successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Package Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** \`$PACKAGE_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** \`$PACKAGE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [View on PyPI](https://pypi.org/project/$PACKAGE_NAME/$PACKAGE_VERSION/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Install command](https://pypi.org/project/$PACKAGE_NAME/#description): \`pip install $PACKAGE_NAME==$PACKAGE_VERSION\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Publishing failed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error details:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat publish_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Common fixes:**" >> $GITHUB_STEP_SUMMARY
          echo "- Check if version already exists on PyPI" >> $GITHUB_STEP_SUMMARY
          echo "- Verify \`PYPI_API_TOKEN\` secret is set correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure package name is available" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
