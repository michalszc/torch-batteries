name: CI

on:
  push:
    branches:
        - master
  pull_request:
    branches:
        - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [lint, format-check, type-check, test, validate-version]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'pyproject.toml'

    - name: Install dependencies
      run: make install-dev

    - name: Run ${{ matrix.check }}
      run: |
        case "${{ matrix.check }}" in
          lint)
            echo "## ðŸ” Linting Results" >> $GITHUB_STEP_SUMMARY
            if make lint > lint_output.txt 2>&1; then
              echo "âœ… **All linting checks passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Linting failed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Errors found:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat lint_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Fix suggestion:** Run \`make lint-fix\` to auto-fix issues" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            ;;
          format-check)
            echo "## ðŸŽ¨ Code Formatting Check" >> $GITHUB_STEP_SUMMARY
            if make format-check > format_output.txt 2>&1; then
              echo "âœ… **Code is properly formatted!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Formatting issues found!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Format differences:" >> $GITHUB_STEP_SUMMARY
              echo '```diff' >> $GITHUB_STEP_SUMMARY
              cat format_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Fix suggestion:** Run \`make format\` to auto-format code" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            ;;
          type-check)
            echo "## ðŸ”Ž Type Checking Results" >> $GITHUB_STEP_SUMMARY
            if make type-check > mypy_output.txt 2>&1; then
              echo "âœ… **All type checks passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Type checking failed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Type errors found:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat mypy_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Fix suggestion:** Add type hints and fix type errors" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            ;;
          test)
            echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
            if make test > test_output.txt 2>&1; then
              echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Extract test summary
              if grep -q "=" test_output.txt; then
                echo "### Test Summary:" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -E "(passed|failed|error|skipped|=)" test_output.txt | tail -5 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              fi

              # Extract coverage summary
              if grep -q "TOTAL" test_output.txt; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Coverage Report:" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                grep -A 10 "Name.*Stmts.*Miss.*Cover" test_output.txt >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Tests failed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Test output:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat test_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Fix suggestion:** Review failing tests and fix issues" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            ;;
          validate-version)
            echo "## ðŸ”¢ Version Validation" >> $GITHUB_STEP_SUMMARY
            if make validate-version > version_output.txt 2>&1; then
              echo "âœ… **Version validation passed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Validation result:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat version_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Version validation failed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Version mismatch:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat version_output.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ’¡ **Fix suggestion:** Update version in pyproject.toml or __init__.py to match" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            ;;
        esac
